import streamlit as st
import pandas as pd
from datetime import datetime
from io import BytesIO

# íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„
try:
    from opendartreader import OpenDartReader
except ImportError:
    st.error("OpenDartReader íŒ¨í‚¤ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.")
    st.stop()

# âœ… DART API í‚¤ë¥¼ Streamlit Secretsì—ì„œ ê°€ì ¸ì˜¤ê¸°
try:
    api_key = st.secrets["DART_API_KEY"]
except Exception:
    st.error("DART_API_KEYë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Secrets ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.")
    st.stop()

# OpenDartReader ì´ˆê¸°í™”
try:
    dart = OpenDartReader(api_key)
except Exception as e:
    st.error(f"OpenDartReader ì´ˆê¸°í™” ì˜¤ë¥˜: {e}")
    st.stop()

# âœ… Streamlit ê¸°ë³¸ ì„¤ì •
st.set_page_config(page_title="ì¬ë¬´ì œí‘œ ì¡°íšŒ ì•±", layout="centered")
st.title("ğŸ“Š ì¬ë¬´ì œí‘œ ì¡°íšŒ ë° ë‹¤ìš´ë¡œë“œ ì•±")

st.markdown("íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ë©´ ìµœê·¼ ì—°ë„ì˜ ì¬ë¬´ì œí‘œë¥¼ ë¶ˆëŸ¬ì™€ ë³´ì—¬ë“œë¦´ê²Œìš”.")

# âœ… ì‚¬ìš©ì ì…ë ¥
company_name = st.text_input("íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‚¼ì„±ì „ì)", "ì‚¼ì„±ì „ì")

# âœ… ì¡°íšŒ ë²„íŠ¼
if st.button("ğŸ“¥ ì¬ë¬´ì œí‘œ ì¡°íšŒ ë° ë‹¤ìš´ë¡œë“œ"):
    with st.spinner("íšŒì‚¬ ì •ë³´ë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤..."):
        try:
            corp_code = dart.find_corp_code(company_name)
        except Exception as e:
            st.error(f"íšŒì‚¬ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            st.stop()

    if corp_code is None:
        st.error(f"âŒ '{company_name}'ì˜ ê³ ìœ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    else:
        year = datetime.today().year - 1
        with st.spinner(f"{year}ë…„ ì¬ë¬´ì œí‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."):
            try:
                fs = dart.finstate(corp_code, year)
            except Exception as e:
                st.error(f"ì¬ë¬´ì œí‘œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                st.stop()

            if fs is None or fs.empty:
                st.warning(f"'{company_name}'ì˜ {year}ë…„ë„ ì¬ë¬´ì œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            else:
                try:
                    output_df = fs[['sj_nm', 'account_nm', 'thstrm_amount', 'frmtrm_amount']]
                    st.success(f"âœ… '{company_name}'ì˜ {year}ë…„ ì¬ë¬´ì œí‘œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.")
                    st.dataframe(output_df)

                    # âœ… ì—‘ì…€ íŒŒì¼ ë²„í¼ë¡œ ì €ì¥
                    def to_excel(df):
                        output = BytesIO()
                        with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
                            df.to_excel(writer, index=False, sheet_name='ì¬ë¬´ì œí‘œ')
                        output.seek(0)  # ë²„í¼ì˜ í¬ì¸í„°ë¥¼ ì²˜ìŒìœ¼ë¡œ ë˜ëŒë¦¼
                        return output.getvalue()

                    excel_data = to_excel(output_df)

                    st.download_button(
                        label="ğŸ“‚ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ",
                        data=excel_data,
                        file_name=f"{company_name}_{year}_ì¬ë¬´ì œí‘œ.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    )
                except Exception as e:
                    st.error(f"ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                    st.stop()
